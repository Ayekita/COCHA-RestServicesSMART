package com.cocha.business.consulta;

import java.sql.Connection;

import com.cocha.dao.SqlSmartDao;
import com.cocha.dto.bmcliDTO;
import com.cocha.dto.datosSalidaDTO;
import com.cocha.utiles.FechasUtil;

public class getLineaCredito {
	public datosSalidaDTO obtieneLineaCredito(String nemote, Connection conJdbc) throws Exception {		
		bmcliDTO cliente = new bmcliDTO();
		SqlSmartDao sqlSmartDao = new SqlSmartDao();

		cliente = sqlSmartDao.obtenerNemo(nemote, conJdbc);
		datosSalidaDTO salida = new datosSalidaDTO();
		salida.setRut(cliente.getRut());
		salida.setDv(cliente.getDv());
		salida.setNemote(cliente.getNemote());
		salida.setNemogr(cliente.getNemogr());
		salida.setRazonSocial(cliente.getRazonSocial());
		int tasaCambio = sqlSmartDao.obtenerTasaCambio(FechasUtil.getFechaAtual(), conJdbc);
		salida.setTasaCambio(tasaCambio);		
		salida.setLineaAutorizadaCLP(cliente.getLineaCLP());
		salida.setLineaAutorizadaUSD(cliente.getLineaUSD());
		long lineaUtilizadaCLP= sqlSmartDao.obtenerLineaUtilizadaCLP(cliente.getRut(), conJdbc);
		Double lineaUtilizadaUSD= sqlSmartDao.obtenerLineaUtilizadaUSD(cliente.getRut(), conJdbc);
		lineaUtilizadaUSD = FechasUtil.round(lineaUtilizadaUSD, 2);
		salida.setLineaUtilizadaCLP(lineaUtilizadaCLP);
		salida.setLineaUtilizadaUSD(lineaUtilizadaUSD);	
		long lineaDisponibleCLP = cliente.getLineaCLP() - lineaUtilizadaCLP;
		double lineaDisponibleUSD = cliente.getLineaUSD() - lineaUtilizadaUSD;
		lineaDisponibleUSD = FechasUtil.round(lineaDisponibleUSD, 2);
		salida.setLineaDisponibleCLP(lineaDisponibleCLP);
		salida.setLineaDisponibleUSD(lineaDisponibleUSD);

		long lineaEquivalenteAutorizada = 0;
		if(cliente.getLineaCLP() > 0) 	{
			lineaEquivalenteAutorizada += cliente.getLineaCLP();
		}
		if(cliente.getLineaUSD() > 0) {
			cliente.setLineaUSD(cliente.getLineaUSD() * tasaCambio);
			lineaEquivalenteAutorizada += cliente.getLineaUSD();
		}
		salida.setLineaEquivalenteAutorizada(lineaEquivalenteAutorizada);

		long lineaEquivalenteUtilizada = 0;
		if(lineaUtilizadaCLP > 0) {
			lineaEquivalenteUtilizada += lineaUtilizadaCLP;
		}
		if(lineaUtilizadaUSD > 0) {
			lineaUtilizadaUSD = lineaUtilizadaUSD * tasaCambio;
			lineaEquivalenteUtilizada += lineaUtilizadaUSD;
		}
		salida.setLineaEquivalenteUtilizada(lineaEquivalenteUtilizada);
		salida.setLineaEquivalenteUtilizadaUSD(FechasUtil.round((lineaEquivalenteUtilizada/tasaCambio),2));

		long lineaEquivalenteDisponible = 0;
		lineaEquivalenteDisponible = lineaEquivalenteAutorizada - lineaEquivalenteUtilizada;
		salida.setLineaEquivalenteDisponible(lineaEquivalenteDisponible);
		salida.setLineaEquivalenteDisponibleUSD(FechasUtil.round((lineaEquivalenteDisponible/tasaCambio),2));

		salida.setTipo(cliente.getTipo());
		salida.setFrecuencia(cliente.getFrecuencia());
		salida.setReqOC(cliente.getReqOC());

		return salida;
	}
}
